<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="{{ url_for('static', filename='icons/favicon.png') }}" type="image/png">
    <title>Brain Tumor Detection</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/external.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
  </head>

  <body>
    <header>
      <nav class="navbar navbar-expand-sm navbar-dark bg-dark p-3">
        <div class="container-fluid">
        <img src="{{ url_for('static', filename='icons/logo.svg') }}" 
        class="img-fluid rounded-circle me-3"
        alt="Logo"
        height="30px"
        width="30px"
        >
        <a class="navbar-brand" href="/">Brain Tumor Detection</a>
          <ul class="navbar-nav ms-auto">
            <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
            <li class="nav-item"><a class="nav-link" href="/about">About</a></li>
            <li class="nav-item"><a class="nav-link" href="/dataset">Dataset</a></li>
            <li class="nav-item"><a class="nav-link" href="/documents">Documents</a></li>
            <li class="nav-item"><a class="nav-link" href="/maps">Hospitals</a></li>
          </ul>
        </div>
      </nav>
    </header>

    <main>
      <div class="container mt-5 mb-4">
        <h3 class="text-center">Upload Brain MRI Scans</h3>
        <p class="text-center text-muted">This tool uses a deep learning model to analyze MRI images and detect the presence and type of brain tumors.</p>
      </div>

      <div class="container text-center mt-5">
        <form method="POST" enctype="multipart/form-data" onsubmit="showLoading()">
          <div class="mb-4 mt-2">
            <input type="file" class="form-control" name="files" id="fileInput" multiple required>
          </div>
          <button type="submit" class="btn btn-primary">Detect Tumor</button>
        </form>

        <div id="loading" class="text-center">
          <div class="spinner-border text-primary" role="status"></div>
          <p class="mt-2">Processing... Please wait.</p>
        </div>

        {% if predictions %}
        <div id="prediction_table" class="mt-5">
          <h4 class="text-primary mb-4">Results:</h4>
          <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
            {% for item in predictions %}
              <div class="col">
                <div class="card h-100 shadow-sm card-name" style="overflow: hidden; border-radius: 25px; padding: 22px;">
                  <img src="{{ url_for('static', filename='uploaded/' + item.filename) }}"
                       class="card-img-top"
                       alt="MRI Image"
                       style="max-height: 250px; width: 80%; object-fit: cover; border-radius: 25px; display: block; margin: 0 auto;">
                       <div class="card-body">
                    <h5 class="card-title">{{ item.result }}</h5>
                    <p class="card-text text-muted">Confidence: {{ item.confidence }}%</p>
                    <p class="card-text small text-secondary">{{ item.filename }}</p>

                    {% if item.all_probs %}
                    <div class="mt-3">
                      <table class="table table-sm table-bordered mb-0">
                        <thead class="table-light">
                          <tr>
                            <th>Class</th>
                            <th>Confidence (%)</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for cls, conf in item.all_probs.items() %}
                          <tr>
                            <td>{{ cls }}</td>
                            <td>{{ conf|round(2) }}</td>
                          </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                    {% endif %}
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
          
<!-- hospitals suggestions -->
         {% if tumor_detected %}
          <div class="alert alert-primary mt-4" id="hospital-alert">
            <h5>Would you like to see nearby hospitals?</h5>
            <a href="/maps" class="btn btn-light me-2">Yes</a>
            <a href="/" class="btn btn-dark" id="no-button">No</a>
          </div>
         {% endif %} 

<!--Downloading report-->
          <form method="POST" action="/download-report">
            <input type="hidden" name="data" value='{{ predictions | tojson }}'>
            <button type="submit" class="btn btn-outline-dark">&#128196; Download PDF Report</button>
          </form>

        </div>
        {% endif %}

      </div>


    </main>

    <footer class="bg-dark text-white text-center p-3 mt-5">
      <p class="mb-0">&copy; Brain Tumor Detection System</p>
    </footer>


 <!-- Dialog box -->
<div id="custom-dialog" style="display: none;">
    <div id="dialog-content">
        <p>This system is for <strong>academic, research, or training</strong> use only and is not for medical diagnosis. 
            Please consult a professional for any medical concerns.</p>
          <hr>
          <p>Input is restricted to <strong>brain MRI scan images</strong> exclusively; 
            any other image formats or unrelated images should not be used.</p>
          <hr>
        <div id="dialog-buttons">
            <button id="accept-button" class="btn btn-primary">Proceed</button>
            <button id="deny-button" class="btn btn-danger">Exit</button>
        </div>
    </div>
</div> 

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
   <script>
       // Force page to reset on refresh
      if (performance.navigation.type === 1) {
        window.location.href = window.location.pathname;
      }

      // Hide preview image on page load and reset file input
      window.onload = function () {
        const preview = document.getElementById("preview");
        if (preview) {
          preview.src = "#";
          preview.style.display = "none";
        }
        const fileInput = document.getElementById("fileInput");
        if (fileInput) {
          fileInput.value = "";
        }
      };
    //alert section
    document.addEventListener('DOMContentLoaded', (event) => {
    // Find the dialog and buttons
    const dialog = document.getElementById('custom-dialog');
    const acceptButton = document.getElementById('accept-button');
    const denyButton = document.getElementById('deny-button');

     if (!sessionStorage.getItem('dialogShown')) {
        dialog.style.display = 'flex';
    } 

    //Add event listeners for the buttons
    if(acceptButton){
    acceptButton.addEventListener('click', () => {
        dialog.style.display = 'none';
        sessionStorage.setItem('dialogShown', 'true'); // optional: prevent showing again in session
    });
  }

  if(denyButton){
    denyButton.addEventListener('click', () => {
        window.location.href = '/exit'; 
    });
    }
});

 // Show loading spinner
      function showLoading() {
        document.getElementById("loading").style.display = "block";
      }

//hospital eventHandler
document.addEventListener("DOMContentLoaded", () => {
  const noLink = document.getElementById("no-button");
  const alertBox = document.getElementById("hospital-alert");

  if (noLink && alertBox) {
    noLink.addEventListener("click", (e) => {
      e.preventDefault(); // stop page refresh
      alertBox.style.display = "none"; // hide the box
    });
  }
});

</script>
  </body>
</html>
