<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Nearby Hospitals | Brain Tumor Detection</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="icon"
      href="{{ url_for('static', filename='favicon.png') }}"
      type="image/png"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/external.css') }}"
    />
    <!-- leaflet.js map -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- font awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
  </head>

  <body class="bg-light">
    <header>
      <nav class="navbar navbar-expand-sm navbar-dark bg-dark p-3">
        <div class="container-fluid">
          <img
            src="{{ url_for('static', filename='icons/logo.svg') }}"
            class="img-fluid rounded-circle me-3"
            alt="Logo"
            height="30px"
            width="30px"
          />
          <a class="navbar-brand" href="/">Brain Tumor Detection</a>
          <ul class="navbar-nav ms-auto">
            <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
            <li class="nav-item">
              <a class="nav-link" href="/about">About</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/dataset">Dataset</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/documents">Documents</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/maps">Hospitals</a>
            </li>
          </ul>
        </div>
      </nav>
    </header>

    <main class="container mt-5 mb-5">
      <h3 class="text-center mb-4 text-primary">
        Nearby Hospitals for Brain Tumor Treatment
      </h3>
      <p class="text-center text-muted mb-5">
        Here is a curated list of hospitals that specialize in brain tumor care.
        You can use the contact information below to reach them directly.
      </p>
      <div
        id="map"
        style="
          height: 400px;
          width: 100%;
          border-radius: 10px;
          margin-bottom: 30px;
        "
      ></div>

      <div
        class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4"
        id="hospital-container"
      >
        <!-- Dynamic hospitals will load here -->
      </div>

      <p class="text-center text-muted mt-4" id="status-text">
        Requesting location access...
      </p>
    </main>

    <footer>
      <blockquote class="text-center bg-dark text-white p-3">
        &copy; Brain Tumor Detection System
      </blockquote>
    </footer>

    <!-- Custom icons for user and hospital -->
    <script>
      const userIcon = L.divIcon({
        html: `<i class="fas fa-user-circle" style="font-size:32px;color:#0d6efd;"></i>`,
        className: "",
        iconSize: [32, 32],
        iconAnchor: [16, 32],
      });

      const hospitalIcon = L.divIcon({
        html: `<i class="fas fa-hospital-symbol" style="font-size:32px;color:#dc3545;"></i>`,
        className: "",
        iconSize: [32, 32],
        iconAnchor: [16, 32],
      });
    </script>

    <script>
      let map;

      document.addEventListener("DOMContentLoaded", () => {
        if (!navigator.geolocation) {
          document.getElementById("status-text").innerText =
            "Geolocation not supported.";
          return;
        }

        navigator.geolocation.getCurrentPosition(
          (position) => {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;

            // Initialize map
            map = L.map("map").setView([lat, lon], 13);

            L.tileLayer(
              "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",
              {
                attribution: "¬© OpenStreetMap, ¬© CARTO",
              }
            ).addTo(map);

            // User marker
            L.marker([lat, lon], { icon: userIcon })
              .addTo(map)
              .bindPopup("üìç Your location")
              .openPopup();

            fetch(`/get_hospitals?lat=${lat}&lon=${lon}`)
              .then((res) => res.json())
              .then((data) => renderHospitals(data, lat, lon));
          },
          () => {
            document.getElementById("status-text").innerText =
              "Location permission denied.";
          }
        );
      });

      function renderHospitals(hospitals, userLat, userLon) {
        const container = document.getElementById("hospital-container");
        const status = document.getElementById("status-text");

        status.innerText = "Nearby hospitals based on your location:";

        hospitals.forEach((h) => {
          // Add marker
          L.marker([h.lat, h.lon], { icon: hospitalIcon })
            .addTo(map)
            .bindPopup(`<strong>${h.name}</strong><br>${h.distance} km away`);

          // Card
          const col = document.createElement("div");
          col.className = "col";

          col.innerHTML = `
            <div class="card h-100 shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">üè• ${h.name}</h5>
                    <p class="card-text">
                        <strong>Distance:</strong> ${h.distance} km
                    </p>
                    <a href="https://www.google.com/maps/search/?api=1&query=${h.lat},${h.lon}"
                       target="_blank"
                       class="btn btn-primary me-2 px-2 py-1">
                        Open in Google Maps
                    </a>
                    <a href="https://www.google.com/maps/dir/?api=1&destination=${h.lat},${h.lon}"
                       target="_blank"
                       class="btn btn-success px-2 py-1">
                        Get Directions
                    </a>
                </div>
            </div>
        `;
          container.appendChild(col);
        });
      }
    </script>
  </body>
</html>
